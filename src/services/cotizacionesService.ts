import api from "./api";

// ============================================================
// OBTENER COTIZACIONES
// ============================================================
export const getCotizaciones = async () => {
  const response = await api.get("/cotizaciones");
  return response.data;
};

// ============================================================
// CREAR COTIZACIÓN
// ============================================================
export const crearCotizacion = async (datos: {
  clienteId?: number;
  productos: {
    productoId?:  number;
    cantidades:   [number, number, number];
    kilogramos:   [number, number, number];
    precios:      [number, number, number];
    tintasId:     number;
    carasId:      number;
    idsuaje?:     number | null;
    observacion?: string;
    pantones?:    string | null;
    pigmentos?:   string | null;
    modoCantidad?: "unidad" | "kilo";
    porKilo?:     string | null;
    [key: string]: any;
  }[];
  [key: string]: any;
}) => {
  if (!datos.clienteId) {
    throw new Error("Se requiere clienteId para crear la cotización");
  }

  const productos = datos.productos.map((prod) => {
    if (!prod.productoId) {
      throw new Error(`El producto "${prod.nombre}" no tiene ID asignado`);
    }

    const modo = prod.modoCantidad ?? "unidad";

    const detalles = prod.cantidades
      .map((cantidad, i) => {
        if (cantidad <= 0 || prod.precios[i] <= 0) return null;
        return {
          cantidad,
          precio_total: Number((cantidad * prod.precios[i]).toFixed(2)),
          // ✅ modo_cantidad por detalle individual
          modo_cantidad: modo,
          // ✅ kilogramos exactos ingresados (solo útiles en modo kilo)
          kilogramos_ingresados: modo === "kilo" && prod.kilogramos?.[i] > 0
            ? prod.kilogramos[i]
            : null,
        };
      })
      .filter(Boolean);

    if (detalles.length === 0) {
      throw new Error(`El producto "${prod.nombre}" no tiene cantidades o precios válidos`);
    }

    return {
      productoId:  prod.productoId,
      tintasId:    prod.tintasId,
      carasId:     prod.carasId,
      idsuaje:     prod.idsuaje     ?? null,
      observacion: prod.observacion || null,
      pantones:    prod.pantones    ?? null,
      pigmentos:   prod.pigmentos   ?? null,
      porKilo:     prod.porKilo     ?? null,
      detalles,
    };
  });

  const response = await api.post("/cotizaciones", {
    clienteId: datos.clienteId,
    productos,
  });

  return response.data;
};

// ============================================================
// APROBAR O RECHAZAR UN DETALLE INDIVIDUAL
// ============================================================
export const aprobarDetalle = async (detalleId: number, aprobado: boolean) => {
  const response = await api.patch(
    `/cotizaciones/detalle/${detalleId}/aprobar`,
    { aprobado }
  );
  return response.data;
};

// ============================================================
// ACTUALIZAR OBSERVACIÓN DE UN PRODUCTO
// ============================================================
export const actualizarObservacion = async (productoId: number, observacion: string) => {
  const response = await api.patch(
    `/cotizaciones/producto/${productoId}/observacion`,
    { observacion }
  );
  return response.data;
};

// ============================================================
// ACTUALIZAR ESTADO DE LA COTIZACIÓN
// ============================================================
export const actualizarEstado = async (noCotizacion: number, estadoId: number) => {
  const response = await api.patch(
    `/cotizaciones/${noCotizacion}/estado`,
    { estadoId }
  );
  return response.data;
};

// ============================================================
// ELIMINAR COTIZACIÓN
// ============================================================
export const eliminarCotizacion = async (noCotizacion: number) => {
  const response = await api.delete(`/cotizaciones/${noCotizacion}`);
  return response.data;
};